name: generate auto-update PRs
concurrency: generate-auto-update  # do not run this workflow in parallel

on:
  push:
    branches: [ main ]
  schedule:
    - cron:  '0 1,13 * * *'

jobs:
  build-collection:  # deploy collection rdf to gh-pages
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: install script deps
      run: pip install typer ruamel.yaml bioimageio.spec boltons
    - name: generate collection rdf
      run: python scripts/generate_collection_rdf.py
    - name: Deploy collection rdf to gh-pages ðŸš€
      uses: JamesIves/github-pages-deploy-action@4.1.4
      with:
        clean: false
        branch: gh-pages
        folder: dist/gh-pages

  collect-new-resources:
    runs-on: ubuntu-latest
    outputs:
      updated_resources_matrix: ${{ steps.update_known.outputs.updated_resources_matrix }}
      found_new_resources: ${{ steps.update_known.outputs.found_new_resources }}

    steps:
    - uses: actions/checkout@v2
      with:
        persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal access token.
        fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
    - name: install script deps
      run: pip install bioimageio.spec PyGithub lxml
    - name: update known resources
      id: update_known
      run: python scripts/update_known_resources.py collection 5
    - name: "Upload updated collection"
      uses: actions/upload-artifact@v2
      with:
        name: updated-collection
        path: collection
        retention-days: 1

  open-pr:
    needs: [collect-new-resources]
    if: needs.collect-new-resources.outputs.found_new_resources == 'yes'
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1  # to limit content creation (PRs) on github to avoid getting temporary blocked
      fail-fast: false
      # matrix: update: [{resource_id:..., resource_name:..., new_version_ids:..., new_version_sources:..., maintainers: ...}, ...]
      matrix: ${{ fromJson(needs.collect-new-resources.outputs.updated_resources_matrix) }}

    steps:
    - name: download new collection
      uses: actions/download-artifact@v2
      with:
        name: updated-collection
        path: collection
    - name: install script deps
      run: pip install typer ruamel.yaml
    - name: set resource status to accepted
      run: python scripts/set_resource_status.py collection '${{ matrix.update.resource_id }}' '${{ matrix.update.new_version_ids }}' accepted
    - name: Create Pull Request
      id: cpr
      uses: peter-evans/create-pull-request@v3
      with:
        token: ${{ secrets.PAT }}  # using a PAT will make sure we can trigger the CI in PR
        commit-message: 'Update ${{ matrix.update.resource_id }}'
        committer: GitHub <noreply@github.com>
        author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
        signoff: false
        branch: auto-update-${{ matrix.update.resource_id }}
        delete-branch: false  # true does not seem to actually delete the PR branch...? we delete the branch in block_pending.yaml
        title: 'Update ${{ matrix.update.resource_name }}'
        body: |
          resource id: ${{ matrix.update.resource_id }}
          new versions:
          ${{ matrix.update.new_version_ids_md }}

          sources of new versions:
          ${{ matrix.update.new_version_sources_md }}

          deployment preview (will be) available at: [gh-pages-auto-update-${{ matrix.update.resource_id }}](/bioimage-io/collection-bioimage-io/tree/gh-pages-auto-update-${{ matrix.update.resource_id }})
          maintainers: ${{ matrix.update.maintainers }}

          IMPORTANT: If new resource versions are detected this PR branch is beeing **force-pushed**.
          Either merge any manual changes before updates to the external resource occur
          or keep your updates safe in a separate branch and make a PR on [this PR's branch](/bioimage-io/collection-bioimage-io/tree/auto-update-${{ matrix.update.resource_id }}).
        labels: |
          auto-update
        draft: false
