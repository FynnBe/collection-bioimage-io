name: sync

on:
  push:
    branches: [ pyci ]

jobs:
  new-resources:
    runs-on: ubuntu-latest
    outputs:
      model_matrix: ${{ steps.update_known.outputs.model_matrix }}
      rdf_matrix: ${{ steps.update_known.outputs.rdf_matrix }}
      updated_concepts_matrix: ${{ steps.update_known.outputs.updated_concepts_matrix }}

    steps:
    - uses: actions/checkout@v2
      with:
        persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal access token.
        fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
    - name: install deps
      run: pip install typer, requests, ruamel.yaml
    - name: update known resources
      id: update_known
      run: python scripts/update_known_resources.py --collection collection
#    - name: "Upload new resources artefact"
#      uses: actions/upload-artifact@v2
#      with:
#        name: new_resources
#        path: dist/new_resources
#        retention-days: 1
    - name: Commit files
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git commit -m "Add changes" -a
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}

  validate-new-models:
    needs: new-resources
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.new-resources.outputs.model_matrix) }}  # validation_case: [{doi: ..., weight_format: ...}, ...]

    steps:
    - uses: actions/checkout@v2
      with:
        persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal access token.
        fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
#    - run: mkdir -p dist
#    - uses: actions/download-artifact@v2
#      with:
#        name: new_resources
#        path: dist/new_resources
    - name: install validation dependencies
      uses: conda-incubator/setup-miniconda@v2
      with:
        auto-update-conda: true
        mamba-version: "*"
        channel-priority: strict
        activate-environment: bio-spec
        environment-file: dev/environment-mix.yaml  # todo: install deps from rdf
        python-version: 3.8
    - name: validate ${{ matrix.validation_case }}
      shell: bash -l {0}
      run: python scripts/generate_validation_summary.py dist/summaries ${{ matrix.validation_case.doi }} ${{ matrix.validation_case.weight_format }}


#  validate-new-models:
#    needs: new-resources
#    runs-on: ubuntu-latest
#    strategy:
#      fail-fast: false
#      matrix: ${{ fromJson(needs.new-resources.outputs.model_matrix) }}  # validation_case: [{doi: ..., weight_format: ...}, ...]
#
#    steps:
#    - uses: actions/checkout@v2
#      with:
#        persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal access token.
#        fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
##    - run: mkdir -p dist
##    - uses: actions/download-artifact@v2
##      with:
##        name: new_resources
##        path: dist/new_resources
#    - name: install validation dependencies
#      uses: conda-incubator/setup-miniconda@v2
#      with:
#        auto-update-conda: true
#        mamba-version: "*"
#        channel-priority: strict
#        activate-environment: bio-spec
#        environment-file: dev/environment-mix.yaml  # todo: install deps from rdf
#        python-version: 3.8
#    - name: validate ${{ matrix.validation_case }}
#      shell: bash -l {0}
#      run: python scripts/generate_validation_summary.py dist/summaries ${{ matrix.validation_case.doi }} ${{ matrix.validation_case.weight_format }}
#    - name: "Upload new resources artefact"
#      uses: actions/upload-artifact@v2
#      with:
#        name: ${{ matrix.validation_case.doi }}_validation_summary
#        path: dist/summaries
#        retention-days: 90  # todo: what if PR is merged after 90 days?? --> close PR automatically and redo test on reopen
#
#  update-concpets:
#    needs: [validate-new-models]
#    runs-on: ubuntu-latest
#    strategy:
#      matrix: ${{ fromJson(needs.new-resources.outputs.updated_concepts_matrix) }}
