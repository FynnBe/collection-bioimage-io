# if an auto-update-pr was closed (and not merged) we delete the branch to detect the resource anew
# and reopen a new, potentially updated pr
on:
  pull_request:
    branches: [ main ]
    types: [ closed ]

jobs:
  run:
    if: github.event.pull_request.merged == false  # if pr was merged the branch is deleted via gh settings
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: check if remote still exists
      id: ls-remote
      run: |
        out=$(git ls-remote --heads origin ${{ github.event.pull_request.head.ref }})
        echo "::set-output name=out::$out"
    - name: delete PR branch ${{ github.event.pull_request.head.ref }}
      if: contains(steps.ls-remote.outputs.out, 'auto-update-')  # only delete existing auto-update- branches
      run: git push origin --delete ${{ github.event.pull_request.head.ref }}
    - name: trigger collection update
      uses: octokit/request-action@v2.x
      with:
        route: POST /repos/${{ github.repository }}/actions/workflows/update_collection.yaml/dispatches
        ref: refs/heads/main
      env:
        GITHUB_TOKEN: ${{ secrets.PAT }}
